- hosts: "{{ env }}"
  become: yes
  #vars_files:
    #- group_vars/pwd.yml
  tasks:
    - name: Deploying Application pods...
      shell: |
         if [ `kubectl get deployment | grep -v NAME | awk '{print $1}' | grep firstweb | wc -l` -gt 0 ]; then
            echo "deleteing previous application deployment"
            kubectl delete deployment `kubectl get deployment | grep -v NAME | awk '{print $1}' | grep firstweb`
            echo "creating new application deployment"
            kubectl create deployment firstweb --image=adarshadhal/firstweb:{{ build }}
         else
            echo "Deploying Sampleapp Application"
            kubectl create deployment firstweb --image=adarshadhal/firstweb:{{ build }}
         fi
    - name: deploying service
      shell: |
         if [ `kubectl get svc | grep firstweb-svc  | awk '{print $1}' | wc -l` -gt 0 ]; then
            echo "app service found, No actions taken"
            kubectl delete svc `kubectl get svc | grep firstweb-svc | awk '{print $1}'`
         fi
            echo "Creating App Services"
            kubectl expose deployment firstweb --name firstweb-svc --type NodePort --port 8080 --target-port 8082

    - name: increase replicas
      shell: kubectl scale deployment firstweb --replicas=1

    #- name: deploy app
    #  shell: kubectl create deployment sampleapp --image=lerndevops/samplejavaapp:{{ build }}
    #- name: deploy service
    #  shell: kubectl expose deployment sampleapp --name sampleapp --type NodePort --port 80 --target-port 8080
